import { useState, useEffect, useCallback } from "react";
import { Terminal, Globe, Code, Send, AlertCircle, Bot, Loader2 } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { cn } from "@/lib/utils";
import { type Level, type Difficulty } from "@shared/schema";
import { apiRequest } from "@/lib/queryClient";

interface VulnerabilitySimulatorProps {
  level: Level;
  playerInput: string;
  onInputChange: (input: string) => void;
  onSubmit: () => void;
  exploitAttempted: boolean;
  exploitSuccess: boolean;
  difficulty?: Difficulty;
  onAISuccess?: () => void;
  onShowAnswer?: () => void;
}

export function VulnerabilitySimulator({
  level,
  playerInput,
  onInputChange,
  onSubmit,
  exploitAttempted,
  exploitSuccess,
  difficulty = "easy",
  onAISuccess,
  onShowAnswer
}: VulnerabilitySimulatorProps) {
  const [terminalOutput, setTerminalOutput] = useState<string[]>([]);
  const [aiScenario, setAiScenario] = useState<string | null>(null);
  const [aiLoading, setAiLoading] = useState(false);
  const [aiCurrentStep, setAiCurrentStep] = useState(1);
  const [aiTotalSteps, setAiTotalSteps] = useState(1);
  const [aiFeedback, setAiFeedback] = useState<string | null>(null);
  const [sessionId] = useState(() => `session_${Date.now()}_${Math.random().toString(36).substring(7)}`);
  
  const isAILevel = level.isAIGenerated;

  const loadAIChallenge = useCallback(async () => {
    if (!isAILevel) return;
    
    setAiLoading(true);
    setAiFeedback(null);
    try {
      const response = await apiRequest("POST", "/api/ai-challenge/generate", {
        levelId: level.id,
        difficulty,
        sessionId
      });
      const data = await response.json();
      setAiScenario(data.scenario);
      setAiCurrentStep(data.currentStep);
      setAiTotalSteps(data.totalSteps);
    } catch (error) {
      console.error("Failed to load AI challenge:", error);
      setAiScenario("Помилка завантаження ШІ виклику. Спробуйте ще раз.");
    } finally {
      setAiLoading(false);
    }
  }, [isAILevel, level.id, difficulty, sessionId]);

  useEffect(() => {
    if (isAILevel) {
      loadAIChallenge();
    } else {
      const initialLines = getInitialOutput(level, difficulty);
      setTerminalOutput(initialLines);
    }
  }, [level, isAILevel, loadAIChallenge, difficulty]);

  const handleAISubmit = async () => {
    if (!playerInput.trim()) return;
    
    setAiLoading(true);
    setAiFeedback(null);
    
    try {
      const response = await apiRequest("POST", "/api/ai-challenge/verify", {
        sessionId,
        answer: playerInput
      });
      const data = await response.json();
      
      setAiFeedback(data.feedback);
      
      if (data.success) {
        if (data.completed) {
          onAISuccess?.();
        } else {
          setAiScenario(data.nextScenario);
          setAiCurrentStep(data.currentStep);
          setAiTotalSteps(data.totalSteps);
          onInputChange("");
        }
      }
    } catch (error) {
      console.error("Failed to verify AI answer:", error);
      setAiFeedback("Помилка перевірки. Спробуйте ще раз.");
    } finally {
      setAiLoading(false);
    }
  };

  const handleSubmit = () => {
    if (isAILevel) {
      handleAISubmit();
      return;
    }

    const newLines = [...terminalOutput, `> ${playerInput}`];
    
    if (playerInput.toLowerCase().includes(level.solution.toLowerCase()) || 
        playerInput === level.solution) {
      newLines.push("[SUCCESS] Access granted! Vulnerability exploited.");
      newLines.push(`[FLAG] OWASP_CTF{${level.vulnerability.replace(/\s/g, '_').toUpperCase()}}`);
    } else {
      newLines.push("[ERROR] Access denied. Try again.");
    }
    
    setTerminalOutput(newLines);
    onSubmit();
  };

  return (
    <Card className="h-full flex flex-col border-primary/30 bg-card/50 backdrop-blur-sm">
      <CardHeader className="pb-2 border-b border-border">
        <div className="flex items-center justify-between gap-2 flex-wrap">
          <div className="flex items-center gap-2">
            {isAILevel && <Bot className="h-5 w-5 text-primary" />}
            {!isAILevel && level.simulationType === "url-manipulation" && <Globe className="h-5 w-5 text-primary" />}
            {!isAILevel && level.simulationType === "sql-injection" && <Database className="h-5 w-5 text-primary" />}
            {!isAILevel && level.simulationType === "code-review" && <Code className="h-5 w-5 text-primary" />}
            {!isAILevel && !["url-manipulation", "sql-injection", "code-review"].includes(level.simulationType) && 
              <Terminal className="h-5 w-5 text-primary" />}
            <CardTitle className="font-mono text-sm">
              {isAILevel ? "ШІ ВИКЛИК" : getSimulatorTitle(level.simulationType)}
            </CardTitle>
          </div>
          <div className="flex items-center gap-2">
            {isAILevel && aiTotalSteps > 1 && (
              <Badge variant="secondary" className="font-mono text-xs">
                Крок {aiCurrentStep}/{aiTotalSteps}
              </Badge>
            )}
            <Badge variant="outline" className="font-mono text-xs">
              {level.vulnerability}
            </Badge>
          </div>
        </div>
      </CardHeader>
      
      <CardContent className="flex-1 flex flex-col p-0 overflow-hidden">
        <div className="flex-1 overflow-auto p-4 bg-background/80 font-mono text-sm max-h-[300px]">
          {isAILevel ? (
            aiLoading && !aiScenario ? (
              <div className="flex items-center justify-center h-full gap-3">
                <Loader2 className="h-6 w-6 animate-spin text-primary" />
                <span className="text-muted-foreground">Генерування ШІ виклику...</span>
              </div>
            ) : (
              <div className="space-y-4">
                <div className="whitespace-pre-wrap">{aiScenario}</div>
                {aiFeedback && (
                  <div className={cn(
                    "p-3 rounded-lg border",
                    aiFeedback.includes("Правильно") || aiFeedback.includes("успішно") 
                      ? "bg-green-500/10 border-green-500/30 text-green-400"
                      : "bg-yellow-500/10 border-yellow-500/30 text-yellow-400"
                  )}>
                    {aiFeedback}
                  </div>
                )}
              </div>
            )
          ) : (
            renderSimulatorContent(level, terminalOutput, playerInput)
          )}
        </div>
        
        <div className="p-4 border-t border-border bg-card space-y-2">
          <div className="flex gap-2">
            <div className="flex-1 relative">
              <span className="absolute left-3 top-1/2 -translate-y-1/2 text-primary font-mono">
                {">"}
              </span>
              <Input
                value={playerInput}
                onChange={(e) => onInputChange(e.target.value)}
                onKeyDown={(e) => e.key === "Enter" && !aiLoading && handleSubmit()}
                placeholder="Введіть вашу відповідь..."
                className="pl-8 font-mono bg-background border-primary/30 focus:border-primary"
                disabled={exploitSuccess || aiLoading}
                data-testid="input-exploit"
              />
            </div>
            <Button 
              onClick={handleSubmit}
              disabled={!playerInput.trim() || exploitSuccess || aiLoading}
              className="font-mono"
              data-testid="button-submit-exploit"
            >
              {aiLoading ? (
                <Loader2 className="h-4 w-4 mr-2 animate-spin" />
              ) : (
                <Send className="h-4 w-4 mr-2" />
              )}
              {aiLoading ? "ПЕРЕВІРКА..." : "НАДІСЛАТИ"}
            </Button>
          </div>
          {!isAILevel && !exploitSuccess && difficulty === "easy" && (
            <Button 
              onClick={onShowAnswer}
              variant="secondary"
              size="sm"
              className="w-full font-mono text-xs"
              data-testid="button-show-answer"
            >
              Показати правильну відповідь
            </Button>
          )}
          
          {!isAILevel && exploitAttempted && !exploitSuccess && (
            <div className="flex items-center gap-2 mt-2 text-sm text-red-400">
              <AlertCircle className="h-4 w-4" />
              Неправильна відповідь. Спробуйте ще раз!
            </div>
          )}
        </div>
      </CardContent>
    </Card>
  );
}

function getSimulatorTitle(type: string): string {
  const titles: Record<string, string> = {
    "url-manipulation": "URL BROWSER",
    "crypto-attack": "CRYPTO TERMINAL",
    "code-review": "CODE INSPECTOR",
    "sql-injection": "DATABASE LOGIN",
    "config-exploit": "FILE BROWSER",
    "version-exploit": "DEPENDENCY SCANNER",
    "auth-bypass": "LOGIN PORTAL",
    "secrets-hunt": "SOURCE VIEWER",
    "log-analysis": "LOG ANALYZER",
    "error-exploit": "API TESTER",
  };
  return titles[type] || "TERMINAL";
}

function getInitialOutput(level: Level, difficulty: Difficulty = "easy"): string[] {
  const getDifficultyHint = (base: string[]): string[] => {
    if (difficulty === "easy") {
      return base;
    } else if (difficulty === "medium" || difficulty === "hard") {
      return base.filter((_, i) => i !== base.length - 1);
    }
    return base;
  };

  const outputs: Record<number, string[]> = {
    1: getDifficultyHint([
      "╔══════════════════════════════════════╗",
      "║      SECURE ADMIN DASHBOARD v2.1     ║",
      "╚══════════════════════════════════════╝",
      "",
      "Current URL: /dashboard?user=guest",
      "",
      "[INFO] Access Level: GUEST",
      "[INFO] Admin panel requires elevated access",
      "",
      "Hint: URL parameters control access..."
    ]),
    2: getDifficultyHint([
      "╔══════════════════════════════════════╗",
      "║       SECRET VAULT ACCESS            ║",
      "╚══════════════════════════════════════╝",
      "",
      "[ENCRYPTED PASSWORD FOUND]",
      "Base64: c3VwZXJzZWNyZXQxMjM=",
      "",
      "Enter the decoded password to access vault:",
    ]),
    3: getDifficultyHint([
      "╔══════════════════════════════════════╗",
      "║      NPM PACKAGE INSPECTOR           ║",
      "╚══════════════════════════════════════╝",
      "",
      "// analytics-helper@2.3.1/index.js",
      "const trackUser = (data) => {",
      "  sendAnalytics(data);",
      "  // Performance optimization",
      "  stealCredentials(document.cookie);",
      "  return true;",
      "};",
      "",
      "Find the malicious function name:",
    ]),
    4: getDifficultyHint([
      "╔══════════════════════════════════════╗",
      "║         SECURE LOGIN PORTAL          ║",
      "╚══════════════════════════════════════╝",
      "",
      "Username: admin",
      "Password: [INPUT REQUIRED]",
      "",
      "SELECT * FROM users WHERE",
      "  username='admin' AND password='[?]'",
      "",
      "Enter password to login:",
    ]),
    5: getDifficultyHint([
      
      "╔══════════════════════════════════════╗",
      "║         FILE BROWSER v1.0            ║",
      "╚══════════════════════════════════════╝",
      "",
      "Current directory: /public/assets/",
      "",
      "Available files:",
      "  - logo.png",
      "  - styles.css", 
      "  - scripts.js",
      "",
      "Enter file path to view:",
    ]),
    6: getDifficultyHint([
      
      "╔══════════════════════════════════════╗",
      "║      DEPENDENCY VULNERABILITY        ║",
      "╚══════════════════════════════════════╝",
      "",
      "Scanning project dependencies...",
      "",
      "  jquery@1.6.1  [VULNERABLE!]",
      "  lodash@4.17.21  [OK]",
      "  react@18.2.0  [OK]",
      "",
      "Find CVE number for jQuery 1.6.1:",
    ]),
    7: getDifficultyHint([
      
      "╔══════════════════════════════════════╗",
      "║       CORPORATE LOGIN SYSTEM         ║",
      "╚══════════════════════════════════════╝",
      "",
      "[WARNING] Default credentials detected!",
      "[INFO] System was never properly configured",
      "",
      "Login format: username:password",
      "",
      "Enter credentials:",
    ]),
    8: getDifficultyHint([
      
      "╔══════════════════════════════════════╗",
      "║       SOURCE CODE VIEWER             ║",
      "╚══════════════════════════════════════╝",
      "",
      "// config.js (minified)",
      "const API_KEY='sk-abc123';",
      "const AWS_ACCESS='AKIAIOSFODNN7EXAMPLE';",
      "const DB_PASS='prod_pass_2024';",
      "",
      "Find the AWS access key:",
    ]),
    9: getDifficultyHint([
      
      "╔══════════════════════════════════════╗",
      "║         SERVER LOG ANALYZER          ║",
      "╚══════════════════════════════════════╝",
      "",
      "[2024-01-15 10:23:45] 192.168.1.50 - Login SUCCESS",
      "[2024-01-15 10:24:01] 192.168.1.100 - Login FAILED",
      "[2024-01-15 10:24:02] 192.168.1.100 - Login FAILED",
      "[2024-01-15 10:24:03] 192.168.1.100 - Login FAILED",
      "... (2847 more failed attempts from same IP)",
      "[2024-01-15 11:45:22] 192.168.1.100 - Login FAILED",
      "",
      "Identify the attacking IP address:",
    ]),
    10: getDifficultyHint([
      
      "╔══════════════════════════════════════╗",
      "║          API ENDPOINT TESTER         ║",
      "╚══════════════════════════════════════╝",
      "",
      "POST /api/process",
      "Content-Type: application/json",
      "",
      "Testing error handling...",
      "Try sending unexpected values to trigger",
      "an unhandled exception.",
      "",
      "Enter value to send:",
    ]),
  };
  return outputs[level.id] || ["[SYSTEM] Loading simulator..."];
}

function renderSimulatorContent(level: Level, output: string[], currentInput: string) {
  return (
    <div className="space-y-1">
      {output.map((line, i) => (
        <div 
          key={i} 
          className={cn(
            "whitespace-pre-wrap",
            line.includes("[SUCCESS]") && "text-green-400 font-bold",
            line.includes("[ERROR]") && "text-red-400",
            line.includes("[FLAG]") && "text-yellow-400 font-bold animate-pulse",
            line.includes("[WARNING]") && "text-yellow-400",
            line.includes("[INFO]") && "text-blue-400",
            line.includes("╔") && "text-primary",
            line.includes("║") && "text-primary",
            line.includes("╚") && "text-primary",
            line.startsWith(">") && "text-primary",
          )}
        >
          {line}
        </div>
      ))}
    </div>
  );
}

function Database({ className }: { className?: string }) {
  return (
    <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
      <ellipse cx="12" cy="5" rx="9" ry="3" />
      <path d="M3 5V19C3 20.7 7 22 12 22S21 20.7 21 19V5" />
      <path d="M3 12C3 13.7 7 15 12 15S21 13.7 21 12" />
    </svg>
  );
}
